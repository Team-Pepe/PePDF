{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 64, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/jaena/Downloads/toolsapp/app/api/encrypt-pdf/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\"\nimport { promises as fs } from \"fs\"\nimport path from \"path\"\nimport os from \"os\"\n\nexport const runtime = \"nodejs\"\n\nexport async function POST(request: Request) {\n  try {\n    // Usar node-qpdf2 (requiere tener QPDF instalado en el sistema)\n    const { encrypt } = await import(\"node-qpdf2\")\n\n    const formData = await request.formData()\n    const file = formData.get(\"file\") as File | null\n    const password = (formData.get(\"password\") as string) || \"\"\n\n    const printing = formData.get(\"printing\") === \"true\"\n    const modifying = formData.get(\"modifying\") === \"true\"\n    const copying = formData.get(\"copying\") === \"true\"\n    const annotating = formData.get(\"annotating\") === \"true\"\n\n    if (!file) {\n      return NextResponse.json({ error: \"No file provided\" }, { status: 400 })\n    }\n\n    if (!password || password.length < 4) {\n      return NextResponse.json({ error: \"Password must be at least 4 characters\" }, { status: 400 })\n    }\n\n    const arrayBuffer = await file.arrayBuffer()\n    const inputBuffer = Buffer.from(arrayBuffer)\n\n    // Escribir archivo temporal de entrada\n    const tmpDir = await fs.mkdtemp(path.join(os.tmpdir(), \"pdf-encrypt-\"))\n    const inPath = path.join(tmpDir, \"input.pdf\")\n    const outPath = path.join(tmpDir, \"output.pdf\")\n    await fs.writeFile(inPath, inputBuffer)\n\n    // Construir opciones de restricciones para qpdf\n    const restrictions: Record<string, any> = {}\n    // Para 128/256 bits: print: 'full' | 'low' | 'none'\n    restrictions.print = printing ? \"full\" : \"none\"\n    // modify: 'all' | 'annotate' | 'form' | 'assembly' | 'none'\n    restrictions.modify = modifying ? \"all\" : \"none\"\n    // extract: 'y' | 'n'\n    restrictions.extract = copying ? \"y\" : \"n\"\n    // annotate is covered in modify scopes; permitir anotaciones si annotating\n    if (annotating && restrictions.modify === \"none\") {\n      restrictions.modify = \"annotate\"\n    }\n\n    // Ejecutar cifrado real con qpdf (AES-128 por defecto)\n    await encrypt({\n      input: inPath,\n      output: outPath,\n      password,\n      keyLength: 128,\n      restrictions,\n    })\n\n    // Leer PDF encriptado y devolverlo\n    const encryptedBuffer = await fs.readFile(outPath)\n    const outBlob = new Blob([encryptedBuffer], { type: \"application/pdf\" })\n\n    return new NextResponse(outBlob, {\n      status: 200,\n      headers: {\n        \"Content-Type\": \"application/pdf\",\n        \"Content-Disposition\": `attachment; filename=\"encrypted.pdf\"`,\n      },\n    })\n  } catch (error) {\n    console.error(\"[api/encrypt-pdf] Error:\", error)\n    // Mensaje claro si falta QPDF en el sistema\n    const msg =\n      (error instanceof Error && error.message.includes(\"spawn\"))\n        ? \"QPDF no est√° instalado o no es accesible en este servidor.\"\n        : \"Fallo al encriptar el PDF\"\n    return NextResponse.json({ error: msg }, { status: 500 })\n  }\n}"],"names":[],"mappings":";;;;;;AAAA;AACA;AACA;AACA;;;;;AAEO,MAAM,UAAU;AAEhB,eAAe,KAAK,OAAgB;IACzC,IAAI;QACF,gEAAgE;QAChE,MAAM,EAAE,OAAO,EAAE,GAAG;QAEpB,MAAM,WAAW,MAAM,QAAQ,QAAQ;QACvC,MAAM,OAAO,SAAS,GAAG,CAAC;QAC1B,MAAM,WAAW,AAAC,SAAS,GAAG,CAAC,eAA0B;QAEzD,MAAM,WAAW,SAAS,GAAG,CAAC,gBAAgB;QAC9C,MAAM,YAAY,SAAS,GAAG,CAAC,iBAAiB;QAChD,MAAM,UAAU,SAAS,GAAG,CAAC,eAAe;QAC5C,MAAM,aAAa,SAAS,GAAG,CAAC,kBAAkB;QAElD,IAAI,CAAC,MAAM;YACT,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAmB,GAAG;gBAAE,QAAQ;YAAI;QACxE;QAEA,IAAI,CAAC,YAAY,SAAS,MAAM,GAAG,GAAG;YACpC,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAyC,GAAG;gBAAE,QAAQ;YAAI;QAC9F;QAEA,MAAM,cAAc,MAAM,KAAK,WAAW;QAC1C,MAAM,cAAc,OAAO,IAAI,CAAC;QAEhC,uCAAuC;QACvC,MAAM,SAAS,MAAM,yGAAE,CAAC,OAAO,CAAC,4GAAI,CAAC,IAAI,CAAC,wGAAE,CAAC,MAAM,IAAI;QACvD,MAAM,SAAS,4GAAI,CAAC,IAAI,CAAC,QAAQ;QACjC,MAAM,UAAU,4GAAI,CAAC,IAAI,CAAC,QAAQ;QAClC,MAAM,yGAAE,CAAC,SAAS,CAAC,QAAQ;QAE3B,gDAAgD;QAChD,MAAM,eAAoC,CAAC;QAC3C,oDAAoD;QACpD,aAAa,KAAK,GAAG,WAAW,SAAS;QACzC,4DAA4D;QAC5D,aAAa,MAAM,GAAG,YAAY,QAAQ;QAC1C,qBAAqB;QACrB,aAAa,OAAO,GAAG,UAAU,MAAM;QACvC,2EAA2E;QAC3E,IAAI,cAAc,aAAa,MAAM,KAAK,QAAQ;YAChD,aAAa,MAAM,GAAG;QACxB;QAEA,uDAAuD;QACvD,MAAM,QAAQ;YACZ,OAAO;YACP,QAAQ;YACR;YACA,WAAW;YACX;QACF;QAEA,mCAAmC;QACnC,MAAM,kBAAkB,MAAM,yGAAE,CAAC,QAAQ,CAAC;QAC1C,MAAM,UAAU,IAAI,KAAK;YAAC;SAAgB,EAAE;YAAE,MAAM;QAAkB;QAEtE,OAAO,IAAI,gJAAY,CAAC,SAAS;YAC/B,QAAQ;YACR,SAAS;gBACP,gBAAgB;gBAChB,uBAAuB,CAAC,oCAAoC,CAAC;YAC/D;QACF;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,4BAA4B;QAC1C,4CAA4C;QAC5C,MAAM,MACJ,AAAC,iBAAiB,SAAS,MAAM,OAAO,CAAC,QAAQ,CAAC,WAC9C,+DACA;QACN,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAI,GAAG;YAAE,QAAQ;QAAI;IACzD;AACF","debugId":null}}]
}